<!--
  Copyright 2015 Claudio Catterina
  distribuito secondo i termini della Licenza Pubblica Generica GNU
  
  This file is part of AnimazioniDerivataIntegrale.

  AnimazioniDerivataIntegrale is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  AnimazioniDerivataIntegrale is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with AnimazioniDerivataIntegrale.  If not, see <http://www.gnu.org/licenses/>
-->
<html>
  <head>
    <script type="text/javascript" src="DrawUtilities.js"></script>
    <script type="text/javascript" src="jquery-1.11.3.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="bootstrap-3.3.5-dist/js/bootstrap.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap-theme.css">
    <script type="text/javascript" src="js-expression-eval-master/parser.js"></script>
    <script type="text/javascript" src="Function.js"></script>
    <script type="text/javascript" src="Animation.js"></script>
    <script type="text/javascript" src="Interactive.js"></script>
    <script>
        const WIDTH=600;        
        const HEIGHT=400;
        const TIME=20;
        var callID=0;
        var globalaxes=0;
        var globalfunc=0;
        var globalxfis=0;
        /**
         * crea ed inserisce i canvas necessari nel body
         */
        function insertCanvas(){
          createCanvas("Function",WIDTH,HEIGHT,0,10,"visible");
          createCanvas("Buffer",WIDTH,HEIGHT,0,10,"hidden");
          createCanvas("BackgroundFunction",WIDTH,HEIGHT,0,10,"visible");
        }
         /**
         * crea l'animazione al variare della posizione del mouse sul canvas
         * @param  {int} x posizione x del mouse relativa al canvas
         * @param  {int} y posizione y del mouse relativa al canvas
         */
        function drawInteractive(x,y){
          ctx=document.getElementById("Function").getContext("2d");
          //cancello il contenuto del canvas
          ctx.clearRect(0,0,WIDTH,HEIGHT);
          //calcolo xmob come il punto corrispondente alla coordinata x del mouse
          xmob=(x+globalaxes.xmin_px)/globalaxes.scale_x;
          yfis=Parser.evaluate(globalfunc, { x: globalxfis });
          ymob=Parser.evaluate(globalfunc, { x: xmob });
          var interval=(globalxfis-xmob)>0?globalxfis-xmob:xmob-globalxfis; 
          interval=Math.round(interval*globalaxes.scale_x)==0?1:interval;
          //funzione della retta passante per 2 punti
          var functan="(x-("+globalxfis+"))/(("+xmob+")-("+globalxfis+"))*(("+ymob+")-("+yfis+"))+("+yfis+")"; 
          ctx.beginPath();
          var r=Math.round(255-(interval*globalaxes.scale_x));
          ctx.strokeStyle=rgb(r,10,100);
          ctx.lineWidth=2;
          //disegno la retta
          ctx.moveTo(0,HEIGHT-globalaxes.ymin_px-globalaxes.scale_y*Parser.evaluate(functan, { x: globalaxes.xmin }));
          ctx.lineTo(WIDTH,HEIGHT-globalaxes.ymin_px-globalaxes.scale_y*Parser.evaluate(functan, { x: globalaxes.xmax }));
          ctx.stroke();
          ctx.beginPath();
          ctx.fillStyle="black";
          //disegno il primo punto sulla funzione
          ctx.arc(globalxfis*globalaxes.scale_x-globalaxes.xmin_px,HEIGHT-globalaxes.ymin_px-yfis*globalaxes.scale_y,5,0,2*Math.PI);
          ctx.fill();
          ctx.closePath();
          ctx.beginPath();
          ctx.fillStyle="black";
          //disegno il secondo punto sulla funzione
          ctx.arc(xmob*globalaxes.scale_x-globalaxes.xmin_px,HEIGHT-globalaxes.ymin_px-ymob*globalaxes.scale_y,5,0,2*Math.PI);
          ctx.fill();
          ctx.closePath();
        }
        /**
         * controllo dati, preparazione e avvio dell'animazione
         */
        function init()
        {
          var xmin=parseFloat($("#xmin").val());
          var xmax=parseFloat($("#xmax").val());
          var ymin=parseFloat($("#ymin").val());
          var ymax=parseFloat($("#ymax").val());
          var xfis=parseFloat($("#xfis").val());
          var xmob=parseFloat($("#xmob").val());
          var fx=$("#function").val();
          var error=false;
          if (xmin<-1000 || xmax>1000 || ymin<-1000 || ymax>1000)  displayAlert("min_max");else{
            try{
              (Parser.evaluate(fx,{x:0}));
            }
            catch(err){
              error=true;
            }
            if (error) displayAlert("function");else{
              if(xmax-xmin<=0)displayAlert("axes");else{
                if((xfis>xmax)  || (xmob>xmax) || (xfis<xmin) || (xmob<xmin)) displayAlert("xfis_xmob");else{ 
                  document.getElementById("alert").innerHTML="";
            	  	document.getElementById("BackgroundFunction").getContext("2d").clearRect(0,0,WIDTH,HEIGHT);
                	document.getElementById("Function").getContext("2d").clearRect(0,0,WIDTH,HEIGHT);
                	document.getElementById("Buffer").getContext("2d").clearRect(0,0,WIDTH,HEIGHT);       	  
              	  var back_canvas=document.getElementById("BackgroundFunction");
              	  var axes=defineAxes(xmin,xmax,ymin,ymax);
              	  var ctx=back_canvas.getContext("2d");
              	  drawAxes(ctx,axes,1); 
                  drawX0label(ctx,axes,xfis);
              	  var dom=drawFunc(ctx,axes,fx,"rgb(0,0,0)",3);
                  var interval=(xfis-xmob)>0?xfis-xmob:xmob-xfis; 
                  globalaxes=axes;
                  globalfunc=fx;
                  globalxfis=xfis;
                  $("#start").prop("disabled", true);
                  if (px_counter>interval*axes.scale_x){
                    clearInterval(callID);
                    document.getElementById("BackgroundFunction").removeEventListener("mousemove", getPosition, false);
                    document.getElementById("BackgroundFunction").removeEventListener("mousedown", getPosition, false);
                  }
                  callID=setInterval(draw,TIME,axes,fx,dom,xmob,xfis);
                  px_counter=-1;
                }
              }
            }
          }
        }
         /**
         * Disegna i frame dell'animazione
         * @param  {Axes} axes     Assi della funzione
         * @param  {String} fx     funzione 
         * @param  {Dom} dom      Dominio della funzione
         * @param  {Double} xfis  X0
         * @param  {Double} xmob  X che tende a X0
         */
        function draw(axes,fx,dom,xmob,xfis) 
        {
          px_counter++;
          var canvas_function = document.getElementById("Function");
          var canvas_to_use=canvas_function;
          var canvas_buffer = document.getElementById("Buffer");
          if (canvas_function.style.visibility=='hidden')
            var canvas_to_use=canvas_function;
          else
            var canvas_to_use=canvas_buffer;
          if (null==canvas_to_use || !canvas_to_use.getContext) return;
          var ctx=canvas_to_use.getContext("2d");
          var interval=(xfis-xmob)>0?xfis-xmob:xmob-xfis;
          if (px_counter<interval*axes.scale_x)
          {     
            drawDifferenceQuotient(ctx,axes,fx,dom,xfis,xmob); //qui chiamo una delle funzioni
            flipCanvas(canvas_function,canvas_buffer); 
          }
          else{
          	$("#start").prop("disabled", false); 
            document.getElementById("BackgroundFunction").addEventListener("mousemove", getPosition, false);
            document.getElementById("BackgroundFunction").addEventListener("mousedown", getPosition, false);

          }
        }     
        </script>
  </head>
  <body onload="insertCanvas()">
    <ul class="nav nav-tabs" id="menu">
  	   <li role="presentation"><a href="index.html"><b>PRESENTAZIONE</b></a></li>
      <li role="presentation" class="active"><a href="rapporto_incrementale.html">Rapporto Incrementale</a></li>
      <li role="presentation"><a href="derivata.html">Derivata</a></li> 
      <li role="presentation"><a href="segno.html">Segno della derivata</a></li>
      <li role="presentation"><a href="integrale.html">Funzione Integrale</a></li>
      <li role="presentation"><a href="integrale_improprio.html">Integrale Improrio</a></li>
  	</ul>
  	<div id="container" style="padding:20px;">
      <div class="row">
        <div id="alert" ></div>
        <div class="well">
           L'animazione mostra il concetto di derivata prima come limite del rapporto incrementale. (Una volta finita l'animazione e' possibile interagire muovendo il mouse sul disegno della funzione)
        </div>
      </div>
      <div class="row">
        <div class="col-md-2" id="col1" >
          <div class="panel panel-default" >
            <div class="panel-body">
        	  	<div class="form-group" id="form">
        	  		<label for="function">Funzione:</label>
                <input type="text" id="function" value="sin(x)+x^2/20" class="form-control" >
                <label for="xmin">X-min:</label>
                <input type="number" id="xmin" value="-5" step="0.01" class="form-control" min="-1000">
                <label for="xmax">X-max:</label>
                <input type="number" id="xmax" value="5" step="0.01" class="form-control" max="1000">
                <label for="ymin">Y-min:</label>
                <input type="number" id="ymin" value="-2.5" step="0.01" class="form-control" min="-1000">
                <label for="ymax">Y-max:</label>
                <input type="number" id="ymax" value="2.5" step="0.01" class="form-control" max="1000">
                <label for="xfis">X0:</label>
                <input type="number" id="xfis" value="-2" step="0.01" class="form-control" max="1000">
                <label for="xmob">X:</label> 
                <input type="number" id="xmob" value="3" step="0.01" class="form-control" max="1000">
                <br>
                <input type="submit" value="disegna" onclick="init()" class="btn btn-default"  id="start">
        	  	</div>
            </div>
          </div>
        </div> 
        <div class="col-md-8" id="canvas_div">
        </div>
    	</div>
    </div>
    <div style="position:fixed;bottom:0;left:0;background-color: rgba(225, 223, 223, 1);heigth:40cpx;width:100%;z-index:1000;text-align:center;">
          Copyright 2015 Claudio Catterina - distribuito secondo i termini della <a href="COPYING">Licenza Pubblica Generica GNU</a>
    </div>
  </body>
</html>      
